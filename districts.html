<!DOCTYPE html>
<meta charset="utf-8">
<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<style>

body {
	margin:0;
	max-width:940px;
}
	
#wholeApp {
	max-width:940px;
	width:100%;
	margin-top:20px;
}
	
path {
	stroke-linejoin: round;
	stroke-linecap: round;
}

.districts {
	fill: #bbb;
}

.districts :hover {
	fill: orange;
}

.district-boundaries {
	pointer-events: none;
	fill: none;
	stroke: #fff;
	stroke-width: .5px;
}

#tooltip-container {
	position: absolute;
	background-color: #fff;
	color: #000;
	padding: 10px;
	display: none;
	font-family: 'Roboto';
	font-size: 14px;
	padding: 10px;
	border: 1px solid #ccc;
	box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.2);
}

.legend {
	position:absolute;
	background-color:#FFFFFF;
	padding:5px;
	right:800px;
	top:410px;
	box-shadow: 0 8px 6px -6px black;
	font-size: 11px;
	font-family: 'Roboto';
}

</style>

<body>
	<div id="wholeApp">
		<div id="tooltip-container"></div>
		<div id="canvas-svg"></div>
	</div>
</body>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>

	var wholeApp = document.getElementById("wholeApp");
	
	var color = d3.scale.linear()
			  .range(["#73b5ea","#1f76bd","#e49292","#c54646","#e2e2e2"]);

	d3.csv("https://nicolasenault.github.io/districts_results_clea.csv", function(err, data) {
	
		color.domain([0,1,2,3,4]);
		
		var width = wholeApp.clientWidth;
		<!-- width = (width > 940 ? 940 : width) -->
		
		dimensions = {
			width: width,
			height: width - 350
		  };
		  
		var projection = d3.geo.albersUsa()
		.scale(1280)
		.translate([width / 2, dimensions.height / 2]);
	   
		var path = d3.geo.path()
		.projection(projection)

		var legendText = ["Reste démocrate", "Devient démocrate", "Reste républicain", "Devient républicain", "Résultats indisponibles"];
		
		var zoom = d3.behavior.zoom()
		.translate(projection.translate())
		.scale(projection.scale())
		.scaleExtent([2 * dimensions.height, 50 * dimensions.height])
		.on("zoom", zoomed);
		
		function zoomed() {
			projection.translate(d3.event.translate).scale(d3.event.scale);
			svg.selectAll("path").attr("d", path);
		}

		var svg = d3.select("#canvas-svg").append("svg")
		<!-- .call(zoom) -->
		.attr("width", width)
		.attr("height", width - 350);
		

		d3.json("https://nicolasenault.github.io/last_districts.topojson", function(error, congress) {
		
		// Loop through each state data value in the .csv file
		for (var i = 0; i < data.length; i++) {

			// Grab State Name
			var dataId = data[i].id;
			
			// Grab data value 
			var dataElu = data[i].elu;
			var dataState = data[i].fr;
			var dataCirco = data[i].cd115fp;
			
			// Find the corresponding state inside the GeoJSON
			for (var j = 0; j < congress.objects.districts.geometries.length; j++)  {
				var jsonId = congress.objects.districts.geometries[j].properties.ID;
			
				if (dataId == jsonId) {

				// Copy the data value into the JSON
				congress.objects.districts.geometries[j].properties.elu = dataElu; 
				congress.objects.districts.geometries[j].properties.fr = dataState; 
				congress.objects.districts.geometries[j].properties.cd115fp = dataCirco; 
				// Stop looking through the JSON
				break;
				}
			}
		}
				
			svg.append("g")
			.data(congress.objects.districts.geometries)
			.attr("class", "districts")
			.attr("clip-path", "url(#clip-land)")
			.selectAll("path")
			.data(topojson.feature(congress, congress.objects.districts).features)
			.enter().append("path")
			.attr("d", path)
			
			.style("fill", function(d) {
				var value = d.properties.elu;
					if (value=='D') {
					return "#1a80c4";
					} else if (value=='R') {
					return "#cc3d3d";
					}else {
				//If value is undefined…
				return "#e2e2e2";
				}
				})
				
			.on("click", function(d) {	
			var html = "";
				html += "<div class=\"tooltip_kv\">";
				html += "<span class=\"tooltip_key\">";
				html += d.properties.fr;
				html += "</span>";
				html += "<span class=\"tooltip_key\"> - District n°";
				html += d.properties.cd115fp;
				html += "</span>";
				html += "</div>";
						
				$(this).attr("fill-opacity", "0.8");
				$("#tooltip-container").html(html);
				$("#tooltip-container").show();
						
				var coordinates = d3.mouse(this);

				var tooltip_width = $("#tooltip-container").width();
				d3.select("#tooltip-container")
				.style("top", (d3.event.layerY + 25) + "px")
				.style("left", (d3.event.layerX - tooltip_width / 2) + "px");
			})
				
				
			.on("mousemove", function(d) {
				var html = "";
				html += "<div class=\"tooltip_kv\">";
				html += "<span class=\"tooltip_key\">";
				html += d.properties.fr;
				html += "</span>";
				html += "<span class=\"tooltip_key\"> - District n°";
				html += d.properties.cd115fp;
				html += "</span>";
				html += "</div>";
						
				$(this).attr("fill-opacity", "0.8");
				$("#tooltip-container").html(html);
				$("#tooltip-container").show();
						
				var coordinates = d3.mouse(this);

				var tooltip_width = $("#tooltip-container").width();
				d3.select("#tooltip-container")
				.style("top", (d3.event.layerY + 25) + "px")
				.style("left", (d3.event.layerX - tooltip_width / 2) + "px");
			})
			
			.on("mouseout", function() {
				$(this).attr("fill-opacity", "1.0");
				$("#tooltip-container").hide();
			});
				
			svg.append("path")
			.attr("class", "district-boundaries")
			.datum(topojson.mesh(congress, congress.objects.districts, function(a, b) { return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
			.attr("d", path)
			
			var legend = d3.select("body").append("svg")
      			.attr("class", "legend")
     			.attr("width", 140)
    			.attr("height", 100)
   				.selectAll("g")
				.data(color.domain().slice())
   				.enter()
   				.append("g")
     			.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

			legend.append("rect")
				  .attr("width", 18)
				  .attr("height", 18)
				  .style("fill", color );

			legend.append("text")
				  .data(legendText)
				  .attr("x", 24)
				  .attr("y", 9)
				  .attr("dy", ".35em")
				  .text(function(d) { return d; });
		
	  });
});

</script>

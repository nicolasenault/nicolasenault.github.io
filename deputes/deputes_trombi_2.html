
<html xmlns="https://www.w3.org/1999/xhtml" xml:lang="fr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		
		<title>Test députés</title>
	
		<script src="https://d3js.org/d3.v3.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://www.francetvinfo.fr/skin/www/js/libs/underscore/underscore-min.js"></script>
		
		<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
		<link href='https://fonts.googleapis.com/css?family=Roboto:700' rel='stylesheet' type='text/css'>
		  
		<style type="text/css">
		
		* {
			box-sizing: border-box;
		}
		
		html,
		body {
			max-width:940px;
			width:100%
		}
		
		#deputies {
			overflow: hidden;
			float:left;
		}
		
		.depute {
			margin:4px;
			height:250px;
			float: left;
			min-width:150px;
			max-width:150px;
		}
		
		.mugshot {
			width:100%
			max-height:192px;
		}
		
		.noms {
			margin-top:5px;
			margin-left:5px;
			margin-right:5px;
			margin-bottom:5px;
			text-align:center;
			font-family: 'Roboto';
			font-size:12px;
			font-weight:700;
		}
		
		.groupe {
			text-align:center;
			margin-left:5px;
			margin-right:5px;
			font-family: 'Roboto';
			font-size:12px;
		}
		
		.check {
			margin:20px;
			font-family: 'Roboto';
			font-size:12px;
			font-weight:700;
		}
		
		#depCount {
			width:50px;
		}

		#filter {
			max-width:320px;
		}
		
		#votes {
			max-width:320px;
		}
		
		</style>
	</head>
 
	<body>
	
		<div id="depCount" class="fz-200 lh-200">0</div>
		
		<div id="filter">
			<select id="selectArea">
				<option value="">-- Départements --</option>
			</select>
			
			<select id="selectGroup">
				<option value="">-- Groupes --</option>
			</select>
		
			<input type="text" id="search" placeholder="Cherchez votre député">
		</div>
		
		<div id="votes">
			<button type="button" onclick="scrutin(may)">Scrutin du 29 mai</button>
			<button type="button" onclick="scrutin(septembre)">Scrutin du 15 septembre</button>
			<button type="button" onclick="scrutin(envoye)">Scrutin "Envoyé spécial"</button>
		</div>
		
		<select id="selectStatus">
			<option>Vote</option>
		</select>		
		
		<div id="deputies"></div>
	</body>
</html>
<script type="text/javascript">

	var selectArea = document.getElementById("selectArea");
	var optionsArea = ["Ain", "Aisne", "Allier", "Alpes-de-Haute-Provence", "Alpes-Maritimes", "Ardèche", "Ardennes", "Ariège", "Aube", "Aude", "Aveyron", "Bas-Rhin", "Bouches-du-Rhône", "Calvados", "Cantal", "Charente", "Charente-Maritime", "Cher", "Corrèze", "Corse-du-Sud", "Côte-d'Or", "Côtes-d'Armor", "Creuse", "Deux-Sèvres", "Dordogne", "Doubs", "Drôme", "Essonne", "Eure", "Eure-et-Loir", "Finistère", "Français établis hors de France", "Gard", "Gers", "Gironde", "Guadeloupe", "Guyane", "Haut-Rhin", "Haute-Corse", "Haute-Garonne", "Haute-Loire", "Haute-Marne", "Haute-Saône", "Haute-Savoie", "Haute-Vienne", "Hautes-Alpes", "Hautes-Pyrénées", "Hauts-de-Seine", "Hérault", "Ille-et-Vilaine", "Indre", "Indre-et-Loire", "Isère", "Jura", "La Réunion", "Landes", "Loir-et-Cher", "Loire", "Loire-Atlantique", "Loiret", "Lot", "Lot-et-Garonne", "Lozère", "Maine-et-Loire", "Manche", "Marne", "Martinique", "Mayenne", "Mayotte", "Meurthe-et-Moselle", "Meuse", "Morbihan", "Moselle", "Nièvre", "Nord", "Nouvelle-Calédonie", "Oise", "Orne", "Paris", "Pas-de-Calais", "Polynésie Française", "Puy-de-Dôme", "Pyrénées-Atlantiques", "Pyrénées-Orientales", "Réunion", "Rhône", "Saint-Barthélemy et Saint-Martin", "Saint-Pierre-et-Miquelon", "Saône-et-Loire", "Sarthe", "Savoie", "Seine-et-Marne", "Seine-Maritime", "Seine-Saint-Denis", "Somme", "Tarn", "Tarn-et-Garonne", "Territoire de Belfort", "Val-d'Oise", "Val-de-Marne", "Var", "Vaucluse", "Vendée", "Vienne", "Vosges", "Wallis-et-Futuna", "Yonne", "Yvelines"];
	_.each(optionsArea, function(opt) {
		var el = document.createElement("option");
		el.textContent = opt;
		el.value = opt;
		selectArea.appendChild(el);
	});
	
	var selectGroup = document.getElementById("selectGroup");
	var optionsGroup = ["Gauche démocrate et républicaine", "La France insoumise", "La République en Marche", "Les Républicains", "Libertés et Territoires", "Mouvement Démocrate et apparentés", "Non inscrit", "Socialistes et apparentés", "UDI, Agir et Indépendants"];
	_.each(optionsGroup, function(opt) {
		var el = document.createElement("option");
		el.textContent = opt;
		el.value = opt;
		selectGroup.appendChild(el);
	});
	
	var selectStatus = document.getElementById("selectStatus");
	var optionsStatus = ["Pour l'interdiction", "Contre l'interdiction", "Abstention", "Absent(e)"];
	_.each(optionsStatus, function(opt) {
		var el = document.createElement("option");
		el.textContent = opt;
		el.value = opt;
		selectStatus.appendChild(el);
	});

	
	var getDep = document.getElementById("selectArea");
	var choosenDep = null;
	
	var getGroup = document.getElementById("selectGroup");
	var choosenGroup = null;

	var getStatus = document.getElementById("selectStatus");
	var choosenStatus = null;	
	
	getDep.addEventListener("change", function() {
		choosenDep = (this.value.length === 0 ? null : this.value);
		console.log(choosenDep);
		_filterCards();
		_generateCards();
	});

	getGroup.addEventListener("change", function() {
		choosenGroup = (this.value.length === 0 ? null : this.value);
		console.log(choosenGroup);
		_filterCards();
		_generateCards();
	});

	getStatus.addEventListener("change", function() {
		if (this.value.length === 0) return;
		choosenStatus = this.value;
		console.log(choosenStatus);
		_filterCards();
		_generateCards();
	});
	
	var debouncedSearch = _.debounce(_searchDepute, 300);
	var deputeSearch = null;
	
	document.getElementById('search').addEventListener('keyup', debouncedSearch);
	var items = [];
	var filteredItems = [];
	
	d3.csv("https://nicolasenault.github.io//deputes/deputes_clean.csv", function(data) {
		items = data;
		filteredItems = items;
		
		_generateCards();
	});
	
	function _generateCards() {
		$('#deputies').html('');
		for(var i = 0; i < filteredItems.length; i++) {
			var person = filteredItems[i];
			var card = _createCard(person);
			$('#deputies').append(card);
		}
		
		<!-- if filteredItems == 0 { -->
			
		<!-- } -->
		
		var depCount = document.getElementById("depCount");
		depCount.innerHTML = filteredItems.length;
	}
	
	function _filterCards() {
		// TODO recup values filters
		filteredItems = _.filter(items, function(item) {
			//console.log('item ?', item);
			if (choosenDep && choosenDep !== item.dep) {
				return false;
			}
			if (choosenGroup && choosenGroup !== item.groupe) {
				return false;
			}
			
			if (deputeSearch) {
				var reg = new RegExp('(' + deputeSearch +')', 'i');
				var matched = item.deputes.match(reg);
				return (matched && matched.length > 0);
			}
			return true;
		});
		// TODO filter
	}
	
	function _createCard(person) {
		var node = document.createElement('div');
		node.className = 'depute';
		
		node.setAttribute('title', person.deputes);
		node.innerHTML = '<img class="mugshot" src="' + person.photo + '"/><div class="noms">' + person.deputes + '</div><div class="groupe">' + person.groupe + '</div>';
		
		node.addEventListener('click', function() {
			console.log('here', this.getAttribute('title'));
		});
		return node;
	
	}
	
	function _searchDepute() {
		deputeSearch = this.value;
		_filterCards();
		_generateCards();
	}
</script>
